#!/bin/bash

set -e -u -o pipefail
#set -x

declare -a CACHE_NAMES=()
declare -a CACHE_PATHS=()
declare -r SCRIPT=$(basename $0)

info() {
    echo -e "\x1b[32m\xE2\x87\x92 $1\x1b[0m"
}

error() {
    echo -e "\x1b[97m\x1b[41m\x21\x1b[0m \x1b[31m$1\x1b[0m" 1>&2
    exit 1
}

read_help() {
    cat <<eom
Usage: ${SCRIPT} <action> <number>
Examples:
    - vag list: list the vagrant machines
    - vag up 1: launch the machine number 1
    - vag status: the script will prompt user to get the machine number
eom
}

show_usage() {
    echo -e "$(read_help)" 1>&2
    exit 1
}

get_vm_info() {
    local output=($(vagrant global-status | awk '/virtualbox/{print $2" "$5}'))

    local names=
    local paths=

    # probably not the most bash-y way to do it but it works
    for index in ${!output[@]}; do
        if [[ $(($index % 2)) -eq 0 ]]; then
            CACHE_NAMES+=("${output[$index]}")
        else
            CACHE_PATHS+=("${output[$index]}")
        fi
    done
}

get_vm_paths() {
    [[ ${#CACHE_PATHS[@]} -ne 0 ]] || get_vm_info
    echo ${CACHE_PATHS[@]}
}

get_vm_names() {
    [[ ${#CACHE_NAMES[@]} -ne 0 ]] || get_vm_info
    echo ${CACHE_NAMES[@]}
}

get_vm_list() {
    local num=0
    local list=
    local paths=($(get_vm_paths))
    local names=($(get_vm_names))

    for index in ${!paths[@]}; do
        num=$((index+1))
        list+="\x1b[32m${num}) (\x1b[33m${names[$index]}\x1b[32m)\x1b[0m ${paths[$index]}\n"
    done

    echo $list
}

get_vm_choices() {
    cat <<eom
Which machine do you want to use?:
$(echo -e $(get_vm_list) | column -t)
>
eom
}

get_vm_path_by_position() {
    local paths=($(get_vm_paths))
    local position=${1:-}
    local index=$((position-1))
    echo ${paths[$index]}
}

get_vm_name_by_position() {
    local names=($(get_vm_names))
    local position=${1:-}
    local index=$((position-1))
    echo ${names[$index]}
}

ask_for_vm_number() {
    local paths=($(get_vm_paths))
    read -p "$(get_vm_choices) " position
    echo $position
}

is_vagrant_machine() {
    local path=${1:-}
    if [[ -d $path && -f "${path}/Vagrantfile" ]]; then return 0; else return 1; fi
}

is_number() {
    if [[ ${1:-} =~ ^[0-9]+$ ]]; then return 0; else return 1; fi
}

main() {
    local operation=${1:-}
    local position=${2:-}
    local path=
    local name=

    [[ -z ${operation} ]] && show_usage

    if [[ $operation == list ]]; then
        (echo -e $(get_vm_list)) | column -t
    else
        [[ ! -z $position ]] || position=$(ask_for_vm_number)

        if ! $(is_number $position); then
            error "Please provide a valid VM number"
        fi

        path=$(get_vm_path_by_position $position)
        name=$(get_vm_name_by_position $position)

        if ! $(is_vagrant_machine $path); then
            error "$path does not have Vagrantfile"
        fi

        info "VM: ($name) $path"

        cd $path
        vagrant $operation $name
    fi
}

main $@

