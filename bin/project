#!/bin/bash

set -e -u -o pipefail
# set -x
# See .bash_projects

start() {
    PATH="node_modules/.bin:$PATH"

    cd "${PROJECT_DIR}"

    tmux new-session -s "${PROJECT_NAME}" -d
    tmux ls

    tmux new-window -c "$(pwd -P)" -n "server" "npm install && npm run setup && GRAPH_QL=local npm run start"
    tmux new-window -c "$(pwd -P)/graphql" -n "graphql" "npm install && npm run start"
    tmux list-windows
    tmux select-window -t "server"
    tmux attach-session -t "${PROJECT_NAME}"
}

stop() {
    tmux kill-session -t "${PROJECT_NAME}"
    kill "$(pgrep -f '[e]ngineproxy.*')"
}

main() {
    local action=${1:-}

    case "$action" in
        start)
            start
            ;;
        stop)
            stop
            ;;
        *)
          printf "Invalid action: %s\\n" "$action"
    esac
}

main "$@"
