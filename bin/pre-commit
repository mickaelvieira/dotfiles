#!/bin/bash

set -o nounset
set -o errexit
set -o pipefail
#set -x

# To use this hook, run the 2 following commands in the Massmailer root directory

# echo -e '#!/bin/bash\n\nscript="$(dirname "${BASH_SOURCE[0]}")/../../deploy/pre-commit"\nif [[ -f "${script}" ]];\nthen\n\tsource "${script}"\nfi\n' > .git/hooks/pre-commit
# chmod u+x .git/hooks/pre-commit

declare -r base_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd -P)"

declare -r committed_files=$(git diff --name-only --cached | grep -E "^html(.*)js|html|css$")
declare -a files=(${committed_files})

info() {
    echo -e "> $1"
}

error() {
    echo >&2 $1
    exit 1
}

info "Massmailer pre commit script"

cd ${base_dir}

info "Working directory $(pwd -P)"

if [[ ${#files[@]} -eq 0 ]];
then
    info "Not assets to build"
else
    info "These assets need to be built:"

    for file in ${files[@]}
    do
        echo "${file}"
    done

    command -v npm >/dev/null 2>&1 || error "npm is required but it is not installed."

    npm run build_js

    declare -r built_bundles=$(git diff --name-only | grep -E "bundle.js$")
    declare -a bundles=(${built_bundles})

    if [[ ${#bundles[@]} -eq 0 ]];
    then
        info "No bundle to add the commit"
    else

        for bundle in ${bundles[@]}
        do
            info "Adding bundle ${bundle}"
            git add "${bundle}"
        done
    fi

    npm run bust

    info "Adding cache buster file to commit"
    git add buster.json

fi

